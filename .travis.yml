sudo: required
language: ruby
services:
- postgresql
- mysql
- docker
branches:
  only:
  - qa
  - nypl-dams-prod
before_install:
  - gem update --system 3.2.3
  - gem install bundler -v '2.2.15'
rvm:
- 2.6.5
cache: bundler
before_script:
- psql -c 'create database fedora_ingest_rails_test;' -U postgres
- mysql -uroot -e 'CREATE DATABASE ami_filestore_test; CREATE DATABASE image_filestore_test'
- mysql -uroot ami_filestore_test < ./db/resources/ami_filestore_schema.sql
- mysql -uroot image_filestore_test < ./db/resources/image_filestore_schema.sql
script:
- bundle exec rspec
after_success:
- provisioning/travis_ci_and_cd/build_and_push_to_ecr.sh
- provisioning/travis_ci_and_cd/ecs_deploy.sh

env:
  global:
  - secure: "Q+UYWvbSsqH0qRdfaJ9Pd+m2/frhfdg+a3ir76ROuqYPStp4cQiWk7PogupVY1T72lg8p6F0PtEppTgeXAcY3/yqLlKgtwuRNMpo/8hYyPGwJCRzuq9BSeRt062HAXDDshJ5CYfOnWtYyILN569I6Pt4n52+WY9cGoPFDXOFZAlSGy+xYia7ndzbG4Km5idXxI/lyv/VZs/LUqJ6CjU7L6qP2F/wMwDW+V+GkHpQDZSLzr3QOEHPgMiH9T5aP8OlfZKSW9OUdK47pOworsv6vqXVAp+/xwJm7gUsQ1/pKh8SM9d1EjWwBLLNk8srX/dbVYFRQx2IFlRwMWU/3Qc0bfGRUBHdTGjMBLTZ1SHs2CcI/H0mXftcayNX1Rhv6CSW6fjtqiMoI73xkbIVXyF1en69JJQI8OxlNFk4rscCL6N9UDrRzsN3CPnYpGXl19XnRJc2j+b4BXWmo57eR18/UGuSzfmxwdRB0iNkw/yG+1M2hbZSXBEBagPFbEvo5pN5cCsyqSI2omT5LXo01Fhubp3y+oy8mGw64e3Z7syoeOwhIiQgkQ1U2sIC3UETwWO39cXyK1jZaYCm4J7V0UexK23CKV97Hj3FMEIfQXxu19HXcXvtVUDann2hauqO9s1w7sGNJzwB7neGiyGZAiRcl1dEK8lkPJ2yFJ9VYcqxAj0=" # AWS_ACCESS_KEY_ID_QA_NEW nypl-dams-dev 2024-01-01
  - secure: "PIzZf9RdbFAu+jc/p/DqNHdfh6YGfcdwCELdTCq6Nm3UDien53pvO9UbwukezaozSuGnLsk3O1+o5Jf3zTRbp+BAhMbZQqeCfkxoGrPZm2jqmBdWUYZ1bvoF+k4+qaUMOUCEGGpk03TTuR9vksIJ0JB7W+sN5/mHL5gv8LZZBG1vuFzv0TontMbXb0sditlULvyR6AP0oqXiAfPtYlj36XwT85yeJbzEI6pwqy80HWMBVN79+UYPz/Mrz2t2cG5vz8spXsl42z+eXGuzXyD2EbybTA/hIPuUJ3JKc3kh3GzqoNhm8Mkcb2RFdu0HhlcvfQewdZGovtxME+00rLnfn/gODxe+vgKLcDCKf0x5x4b+7up8VSVBz26+1Dt5QU0OHkc+hLTcakOTqekUo+r3/n5DFDZvBkjFAnxGDTcp6OyeoLcv3O98u8htglYYKI1mx58nPqO686RE26FVe3v/40YIMZBfE3HpzPISFyupGLWP3d/nPWDdbX7vUIVU9HfiitpyOd7FBu5+hh6G2/QEXmbBg69Gioza4ucq2YSC5jw6Ud5Y5OIpK6fU5GFlWxRnVe65SQwc0mjXylukdXsAr2bCcip2xkxmZDmMpvhALlLCb6SdtxPfMx7rxY3l8YYUwtgFKrg9qTV/6sdMHwWLS3QcaVajYL0hrEByucYQxa0=" # AWS_SECRET_ACCESS_KEY_QA_NEW nypl-dams-dev 2024-01-01
  - secure: "eAHMbDdLdnkcAzTCWYiZ0zBS7LHcY3eYdjUT6TVjC+QwF3tCSL/g8UlbrecHzuD9b6gd8IZWGifVA8yseNiclUYLqrSQW99SK+WZ6DLdNQf+wicJHI7g3HsxrNqRUGv1csLlQ89kpKQzZZ6aH5ZNDXycOsN3hN8Xz9PZNx30ZVYp8qMOrKsaxaOIR2R60nvzQQfqRU1uzrLreSDXJIm5qJaQdBS61d67aUYiFkVM7ZREvIToFrXlnukeVc/i2KZAXaFgweLDdTBMQitsY637oqv+Cf/CI0GaVkbzhfjYdy8KExbQUtHk5cRCU+Sef7/plkDqa+nZJBImYcUcu+hBnW9F46e8d8LE82F64YM8c95oVI9LK1+pZ/LADuB19eZbxn0PUOz+JiqI64wNAoY1gVmp3hgz/RYCL/y4K352Cb+2AgAgnrxrEGCsoXMgZQvIbAShtM7FVl1zTKynLjhHRPLWR58ZSjK0T+moPy/Pn5WosCltaSXZUo2ol131zLnC5OObCoG+LD7RuZzrHf6Q4yGuHExG0s1jd5FQRBCialjA+dFsb89vP6sgPGaLmuH92RSwETu1pkCvQyMu3WYTTCS+rGVycCoWCeMMVY+gWZhGL81VbBSt3zCriE4QLYAuupKAPcDymj4dlvXP396lojENVc7uy+hIv13WP4aQ/08=" # AWS_ACCESS_KEY_ID_PRODUCTION_NEW nypl-dams-prod 2024-01-01
  - secure: "Giv/mTzHnSXE9emCnWvJGlLnaZA+f8CLdGYTnNyoL5reMVQbkvyTYpqRzeAE3T/+gS8W544udxQRMjIHwrA8ZJTxpBIdSj+NZFj8ACH5mZzRcMvV+ST3PtVV5mdnsC1k6rGJE/Gc6vWAL6IJKOqLP+7B153AMyK1EkP9bz37Qy8pTVTmGC5afWKmlDR5xXJ6dVgLqqWOQpPkBiBtIu4MZkxFMXnvdJMGmxHpZyXalqPIGvcAF46HgU1owud/CCko/U0SIDeiAi2pdMRfm0sbpU9EkAkoP0iETVOIJfcohiR9xr2/108JHwo1PI0IZUvinvuZHZZvYRcK5FoLAU3i4CeXaSDXmOk6WT0MNkFLi+CBnKST7S7URuUtxigtDgELxvofyLPycaWW9tlvFGM6r3ExONoe7CK8GixSlEgDfqeMLAcBFVH6D80iTZIX4UwYI2NE9v7HDR0MunfYgg+9EFayjzl2qWjCjqfq8yWNVnZzongVsCXTMERYqM7iMthFScj/F3VD1bwcvAGX/ScjHOFt32xTitXl33jlZ017enxN+M4FxDhaO9uVxEh2vrKeGVNnnFtaFe4jxB1t64kXjPgBXAqF/O2g7JaO6ENvlV8dlQotxIVZmEP5lytek5fd3MjhlMmUd4Ds3pytua0sFn1A9YMmY4myBlZOEm+Q++M=" # AWS_SECRET_ACCESS_KEY_PRODUCTION_NEW nypl-dams-prod 2024-01-01
  - REMOTE_IMAGE_URL_QA_NEW=685731035297.dkr.ecr.us-east-1.amazonaws.com/fedora-ingest
  - REMOTE_IMAGE_URL_PRODUCTION_NEW=557492996044.dkr.ecr.us-east-1.amazonaws.com/fedora-ingest
