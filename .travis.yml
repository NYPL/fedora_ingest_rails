sudo: required
language: ruby
services:
- postgresql
- mysql
- docker
branches:
  only:
  - qa
  - nypl-dams-prod
before_install:
  - gem update --system 3.2.3
  - gem install bundler -v '2.2.15'
rvm:
- 2.6.5
cache: bundler
before_script:
- psql -c 'create database fedora_ingest_rails_test;' -U postgres
- mysql -uroot -e 'CREATE DATABASE ami_filestore_test; CREATE DATABASE image_filestore_test'
- mysql -uroot ami_filestore_test < ./db/resources/ami_filestore_schema.sql
- mysql -uroot image_filestore_test < ./db/resources/image_filestore_schema.sql
script:
- bundle exec rspec
after_success:
- provisioning/travis_ci_and_cd/build_and_push_to_ecr.sh
- provisioning/travis_ci_and_cd/ecs_deploy.sh

env:
  global:
  - secure: "lXSUvGzg2IVV40a96gZ2b5yHh/y2wKP0iGKh5zfgTEZiq5RjiyLsSXnJGoxGXP7JyH//TUjQgKWhrAGZyHfzVXmtpiVkMiGe7Im+78GQl4JTszVng2YcoTOxdegI2Nnnta2WoQVupCR7vBMqOrzOIzSDJkM0rtz+V9rYfFnevTqrRf7pv0UrT1ZNdKKz6BZ1vzliWgmq2RB2LT5XgJPg+FRU8E5Tg8NMRRcWXcFrT1/W0w21oVHNMMeL6JSQPXr034ueJ7X/6GLYqdLQ+25GnY8hMTO4PrOpXWzvkqqdubZVdhaKfVxf63hACg5vaNSUY2R7DyBUFPUfZCOQbHeAU752SgQNjnS/fNDBeyI/y9f6SmuxPezRiKJcWZek6E7aheCFft4XSlkt7SmICTMkEH9fnnh2x4ZMQ46Ij7W6+vQRmHzH/rCsGGQZwLwYVwh/sEloP0zviJo8YCEHb5bW2/UmK7vmfCvEROWNYnFCNsJcM1mTZtyqTrVqOsP07dy6Flqqf0LwOQnDxIcU1Fgm77PMynQrzrNhIeHQOkLKlDYDoxVsK+Dylsw9jEE2oOMZsg3mzlrVRBl38GjBQQ00FIvsQHMnHN0/YHvdFPf+NGlhnb2ScIhYLXRcd1W2z0pFWu1BkJw4lgnA4ol9+S9xIX9PbgwXy9/YrK/cUW+DbxY=" # AWS_ACCESS_KEY_ID_QA_NEW nypl-dams-dev 20240131
  - secure: "gnU8D35Dva4et7ZI9dBEa/2RbMGhuXg3Iupk7a7F2if0T5RP8cm3UzcMJKckn8pjMYx+oy7sYwP6y7jXV4g3TeaGahHzLLR5BagylnOCWlXvRSEzHKFrPNkXmP82l3Czich5sVIIiQaKlJzxMfBmUjfLhZ6badaHu1d20tPYV/7At9puhARNnqiNMvEs/iJ+AasUChJCL5XN9yMqGKInHCkrH4bGVAOQPD0hwvPBMQjaTS+P7RTvZ+4cULEBEuM19w5XzEJZhXEsy8SGlUf7yVuyf2XnSsf6C/CfrKJbGi9QkmUoT+pZTBPCnI6c+xGFMs1J+zpIGoMx2AgbV2Y8QzmWkA9EeWcK2UsWmtSlSw0Bu+FrTRqLKCf2NkZoG4qD64dNqeZ2SChoPSi+NM9tyfBYoGo4Sgdj98mhh9aspoq6V0EjVrBpwdj66Uv7iqBYYYS6Hd7nIxDH0JZoLUl3qY40mmrO079mm0wzKJDBZU0LR/VmgHHOdzCLzQ3AwgrICZpzydYPwEVzyyN1FKc0Kg3mbqAVWNyqMlFCnbObtdH5oyYdez6LwHCax9kvquOWlTMotNfuz+8cNE/PDKtll13WiraGbU1BSE0S0kCE2YWvPZxXdQUMJyDb7f3MWc7gohIHCd428sWaoTN+TUq1MZrYUwPv733ikcYY5QGRKHA=" # AWS_SECRET_ACCESS_KEY_QA_NEW nypl-dams-dev 20240131
  - secure: "eAHMbDdLdnkcAzTCWYiZ0zBS7LHcY3eYdjUT6TVjC+QwF3tCSL/g8UlbrecHzuD9b6gd8IZWGifVA8yseNiclUYLqrSQW99SK+WZ6DLdNQf+wicJHI7g3HsxrNqRUGv1csLlQ89kpKQzZZ6aH5ZNDXycOsN3hN8Xz9PZNx30ZVYp8qMOrKsaxaOIR2R60nvzQQfqRU1uzrLreSDXJIm5qJaQdBS61d67aUYiFkVM7ZREvIToFrXlnukeVc/i2KZAXaFgweLDdTBMQitsY637oqv+Cf/CI0GaVkbzhfjYdy8KExbQUtHk5cRCU+Sef7/plkDqa+nZJBImYcUcu+hBnW9F46e8d8LE82F64YM8c95oVI9LK1+pZ/LADuB19eZbxn0PUOz+JiqI64wNAoY1gVmp3hgz/RYCL/y4K352Cb+2AgAgnrxrEGCsoXMgZQvIbAShtM7FVl1zTKynLjhHRPLWR58ZSjK0T+moPy/Pn5WosCltaSXZUo2ol131zLnC5OObCoG+LD7RuZzrHf6Q4yGuHExG0s1jd5FQRBCialjA+dFsb89vP6sgPGaLmuH92RSwETu1pkCvQyMu3WYTTCS+rGVycCoWCeMMVY+gWZhGL81VbBSt3zCriE4QLYAuupKAPcDymj4dlvXP396lojENVc7uy+hIv13WP4aQ/08=" # AWS_ACCESS_KEY_ID_PRODUCTION_NEW nypl-dams-prod 2024-01-01
  - secure: "Giv/mTzHnSXE9emCnWvJGlLnaZA+f8CLdGYTnNyoL5reMVQbkvyTYpqRzeAE3T/+gS8W544udxQRMjIHwrA8ZJTxpBIdSj+NZFj8ACH5mZzRcMvV+ST3PtVV5mdnsC1k6rGJE/Gc6vWAL6IJKOqLP+7B153AMyK1EkP9bz37Qy8pTVTmGC5afWKmlDR5xXJ6dVgLqqWOQpPkBiBtIu4MZkxFMXnvdJMGmxHpZyXalqPIGvcAF46HgU1owud/CCko/U0SIDeiAi2pdMRfm0sbpU9EkAkoP0iETVOIJfcohiR9xr2/108JHwo1PI0IZUvinvuZHZZvYRcK5FoLAU3i4CeXaSDXmOk6WT0MNkFLi+CBnKST7S7URuUtxigtDgELxvofyLPycaWW9tlvFGM6r3ExONoe7CK8GixSlEgDfqeMLAcBFVH6D80iTZIX4UwYI2NE9v7HDR0MunfYgg+9EFayjzl2qWjCjqfq8yWNVnZzongVsCXTMERYqM7iMthFScj/F3VD1bwcvAGX/ScjHOFt32xTitXl33jlZ017enxN+M4FxDhaO9uVxEh2vrKeGVNnnFtaFe4jxB1t64kXjPgBXAqF/O2g7JaO6ENvlV8dlQotxIVZmEP5lytek5fd3MjhlMmUd4Ds3pytua0sFn1A9YMmY4myBlZOEm+Q++M=" # AWS_SECRET_ACCESS_KEY_PRODUCTION_NEW nypl-dams-prod 2024-01-01
  - REMOTE_IMAGE_URL_QA_NEW=685731035297.dkr.ecr.us-east-1.amazonaws.com/fedora-ingest
  - REMOTE_IMAGE_URL_PRODUCTION_NEW=557492996044.dkr.ecr.us-east-1.amazonaws.com/fedora-ingest
