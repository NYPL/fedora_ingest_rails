sudo: required
language: ruby
services:
- postgresql
- mysql
- docker
branches:
  only:
  - qa
  - nypl-dams-prod
before_install:
  - gem update --system 3.2.3
  - gem install bundler -v '2.2.15'
rvm:
- 2.6.5
cache: bundler
before_script:
- psql -c 'create database fedora_ingest_rails_test;' -U postgres
- mysql -uroot -e 'CREATE DATABASE ami_filestore_test; CREATE DATABASE image_filestore_test'
- mysql -uroot ami_filestore_test < ./db/resources/ami_filestore_schema.sql
- mysql -uroot image_filestore_test < ./db/resources/image_filestore_schema.sql
script:
- bundle exec rspec
after_success:
- provisioning/travis_ci_and_cd/build_and_push_to_ecr.sh
- provisioning/travis_ci_and_cd/ecs_deploy.sh

env:
  global:
  - secure: "dR6Bj2KjGeV/pHClVV8MLbIAqwsgja+ge0ZCveGeutuhpmImhlOSWJ2JaKmRIv4OJE23HFzTGam5gHJHWPjidLETNnBg6ZLcCG12tZBjDo4ZTshD4Q2PginE2grSvvzJeCx1vXLkttFEJN/nujGIEHmve/RjHlY/9Q5eGcgoWj39fn+zJUyFowxWyxAHwd77g8vtfWK19FBvc0wKXrCOk+n74ev1w6J3jVvghEglF7Da6ANFsqOLGJmIQF1XKoY0/eXT5VnYdnYHMIAEfBsXm0Fts4O36yPHgwQ8ZKYwYRqarqmKh2iwiuCeSrxuJmyqaQDANX0n9eKPhX993FrTSPZVNS6a9yylFRblkSjxWis7cuJLgZhTZc17JOLDraPCdAWUE1T1ALfn246B1OEl5Hz9/lXUVdQqx06+VD/aEYBUEy/hAMvS6HTtGf4bPjFx0CXLRgtky24/yEK3BAFRsMKm/Ke3fPnvvzy4l1xEAirWiHx5o45B3H4pvlWpAQIj4Jh6a/Za9WdCQmr04t5l3pz1Vstph7atwBFl29d+dKAlp6/EBtEddX2nhbGRBHbdRmgMTNLku16HTLjF6MPbD3h6jQfjcb6wYr0n4c0tcDtDpZWo6EBQBCPUF6HoDRPervbmAoIWWkSOHM7PbUpTf7hzdrfj0OaCdILysyI+n1M=" # AWS_ACCESS_KEY_ID_QA_NEW nypl-dams-dev 20240130
  - secure: "r4M70lktU2B24G9vhpBGuYoqZaWf8JxgIDUAz71Wqk0ISyTtn+eef9QLA2YEt7b3TjBEJsc63HYA0k5P+Mfegn0+CO2CG+OoMvBsSj5ingOGwFKFAjTIE7mWPDSHVoYFfpXPzIxQ5T6PrKPu8Zi7ONmwo5f20TeM8FEuVU1qDrx1D+9GRaUi/tCig8WSr0X3/y+9m4IcuTP8MkJAeqSfVq9hXdnrlE4vLUHPuXeTcKd1rqRoC3iFgsAV4LpVwHEVEKUzZ41l3XwMzjoCrmmJvgHwHBhmETKGFL33SfZqfRY1N2TCj08kwcQRJ7szqLLVb+z3OZ1/zIyCDd8JjTssYLdZuHjtb6dxN7zMXuXfouguO1C64OzUicirVDFcNCuWEZJn14yMk0zUh6WFOwavaocgxfyWA7dJyoEZkkozSir+Tn8dcSsOIQ3ukdBVGrBaP3c3cS5hi/6G9pvnPLwYAjrda+a6Zp4OysMb4pjtPokVVgexyZIZjC7cB/JaA0VrU9z9vaNx+wlVbhKzGUbkM6xtjSvmEMQGzfKofw0Rr4pt/n1j/qccvchS1KXtwqefIAWQN5hScEg0p/KX1RrZHDiP1G01Oszr345AbpemtND6D3CJ3eCIjPGLb1MT+nBWLkqwn7Y8fpI4+ePFNezxZSawy3BltmfbxrFd9kxlarQ=" # AWS_SECRET_ACCESS_KEY_QA_NEW nypl-dams-dev 20240130
  - secure: "eAHMbDdLdnkcAzTCWYiZ0zBS7LHcY3eYdjUT6TVjC+QwF3tCSL/g8UlbrecHzuD9b6gd8IZWGifVA8yseNiclUYLqrSQW99SK+WZ6DLdNQf+wicJHI7g3HsxrNqRUGv1csLlQ89kpKQzZZ6aH5ZNDXycOsN3hN8Xz9PZNx30ZVYp8qMOrKsaxaOIR2R60nvzQQfqRU1uzrLreSDXJIm5qJaQdBS61d67aUYiFkVM7ZREvIToFrXlnukeVc/i2KZAXaFgweLDdTBMQitsY637oqv+Cf/CI0GaVkbzhfjYdy8KExbQUtHk5cRCU+Sef7/plkDqa+nZJBImYcUcu+hBnW9F46e8d8LE82F64YM8c95oVI9LK1+pZ/LADuB19eZbxn0PUOz+JiqI64wNAoY1gVmp3hgz/RYCL/y4K352Cb+2AgAgnrxrEGCsoXMgZQvIbAShtM7FVl1zTKynLjhHRPLWR58ZSjK0T+moPy/Pn5WosCltaSXZUo2ol131zLnC5OObCoG+LD7RuZzrHf6Q4yGuHExG0s1jd5FQRBCialjA+dFsb89vP6sgPGaLmuH92RSwETu1pkCvQyMu3WYTTCS+rGVycCoWCeMMVY+gWZhGL81VbBSt3zCriE4QLYAuupKAPcDymj4dlvXP396lojENVc7uy+hIv13WP4aQ/08=" # AWS_ACCESS_KEY_ID_PRODUCTION_NEW nypl-dams-prod 2024-01-01
  - secure: "Giv/mTzHnSXE9emCnWvJGlLnaZA+f8CLdGYTnNyoL5reMVQbkvyTYpqRzeAE3T/+gS8W544udxQRMjIHwrA8ZJTxpBIdSj+NZFj8ACH5mZzRcMvV+ST3PtVV5mdnsC1k6rGJE/Gc6vWAL6IJKOqLP+7B153AMyK1EkP9bz37Qy8pTVTmGC5afWKmlDR5xXJ6dVgLqqWOQpPkBiBtIu4MZkxFMXnvdJMGmxHpZyXalqPIGvcAF46HgU1owud/CCko/U0SIDeiAi2pdMRfm0sbpU9EkAkoP0iETVOIJfcohiR9xr2/108JHwo1PI0IZUvinvuZHZZvYRcK5FoLAU3i4CeXaSDXmOk6WT0MNkFLi+CBnKST7S7URuUtxigtDgELxvofyLPycaWW9tlvFGM6r3ExONoe7CK8GixSlEgDfqeMLAcBFVH6D80iTZIX4UwYI2NE9v7HDR0MunfYgg+9EFayjzl2qWjCjqfq8yWNVnZzongVsCXTMERYqM7iMthFScj/F3VD1bwcvAGX/ScjHOFt32xTitXl33jlZ017enxN+M4FxDhaO9uVxEh2vrKeGVNnnFtaFe4jxB1t64kXjPgBXAqF/O2g7JaO6ENvlV8dlQotxIVZmEP5lytek5fd3MjhlMmUd4Ds3pytua0sFn1A9YMmY4myBlZOEm+Q++M=" # AWS_SECRET_ACCESS_KEY_PRODUCTION_NEW nypl-dams-prod 2024-01-01
  - REMOTE_IMAGE_URL_QA_NEW=685731035297.dkr.ecr.us-east-1.amazonaws.com/fedora-ingest
  - REMOTE_IMAGE_URL_PRODUCTION_NEW=557492996044.dkr.ecr.us-east-1.amazonaws.com/fedora-ingest
